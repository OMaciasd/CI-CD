---
name: "$(BuildDefinitionName)_$(Build.SourceBranchName)_$(Major).$(Minor).$(Patch)"

variables:
    - name: Major
      value: 1
    - name: Minor
      value: 0
    - name: Patch
      value: $[counter(format('{0}.{1}', variables['Major'], variables['Minor']), 0)]

resources:
    repositories:
        - repository: $ORGANIZATION-infra
          type: git
          name: "$PROJECT/$ORGANIZATION-infra"

trigger:
  tags:
    include:
    - '*'
  branches:
    include:
    - main
  paths:
    include:
    - src
    exclude:
    - docs
    - pipelines

pool: "Agent Pool $ORGANIZATION"

stages:
    - stage: "Build"
      jobs:
          - deployment: build
            continueOnError: false
            environment: "dev"
            variables:
                - group: dev-key-vault-credential
                - group: sops-key-vault

            strategy:
                runOnce:
                    deploy:
                        steps:
                            - checkout: self

                            - script: |
                                eval $(SOPS_PAT)
                              displayName: 'Download sops.yaml'

                            - template: "templates/installSOPS.yml@$ORGANIZATION-infra"

                            - template: "templates/encryptSOPS.yml@$ORGANIZATION-infra"
                              parameters:
                                  FileToEncryptWithPath: "$(System.DefaultWorkingDirectory)/appsettings.json"
